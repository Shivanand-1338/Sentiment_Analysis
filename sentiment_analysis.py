# -*- coding: utf-8 -*-
"""Sentiment_Analysis.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tjrEot228Lp0N1RN7HFfwiWvQfRSkMTI
"""

# Run once at the top of the notebook
!pip install -q datasets transformers evaluate scikit-learn matplotlib seaborn
# If you want accelerate for faster HF training
!pip install -q accelerate

import os
import random
import numpy as np
from datasets import load_dataset
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import matplotlib.pyplot as plt
import seaborn as sns

# Reproducibility
RANDOM_SEED = 42
random.seed(RANDOM_SEED)
np.random.seed(RANDOM_SEED)

# Loads IMDB (train/test split). Each item has 'text' and 'label' (0=neg,1=pos)
dataset = load_dataset("imdb")
print(dataset)
# We'll take a smaller subset for quick iteration (optional)
train_ds = dataset['train']   # 25k
test_ds = dataset['test']     # 25k

# Convert to lists
X_train = [x['text'] for x in train_ds]
y_train = [x['label'] for x in train_ds]
X_test  = [x['text'] for x in test_ds]
y_test  = [x['label'] for x in test_ds]

# (Optional) Quick smaller subset for very fast runs
# subset = 5000
# X_train, _, y_train, _ = train_test_split(X_train, y_train, train_size=subset, random_state=RANDOM_SEED)

tfidf = TfidfVectorizer(
    max_features=30000,   # adjust based on memory; 30k is reasonable
    ngram_range=(1,2),
    stop_words='english'
)

X_train_tfidf = tfidf.fit_transform(X_train)
X_test_tfidf  = tfidf.transform(X_test)

print("TF-IDF shapes:", X_train_tfidf.shape, X_test_tfidf.shape)

model = LogisticRegression(max_iter=1000, n_jobs=-1)
model.fit(X_train_tfidf, y_train)

preds = model.predict(X_test_tfidf)
print("Accuracy:", accuracy_score(y_test, preds))
print(classification_report(y_test, preds, digits=4))

# Confusion matrix plot
cm = confusion_matrix(y_test, preds)
plt.figure(figsize=(5,4))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.xlabel('Predicted'); plt.ylabel('Actual'); plt.title('Confusion Matrix')
plt.show()

import pickle
os.makedirs("models", exist_ok=True)
with open("models/tfidf.pkl", "wb") as f:
    pickle.dump(tfidf, f)
with open("models/logreg.pkl", "wb") as f:
    pickle.dump(model, f)
print("Saved tfidf and logistic model to /content/models/")

import pickle

# Load saved objects
with open("models/tfidf.pkl", "rb") as f:
    tfidf_loaded = pickle.load(f)

with open("models/logreg.pkl", "rb") as f:
    model_loaded = pickle.load(f)

def predict_sentiment_saved(text):
    X = tfidf_loaded.transform([text])
    pred = model_loaded.predict(X)[0]
    prob = model_loaded.predict_proba(X)[0][1]
    sentiment = "POSITIVE" if pred == 1 else "NEGATIVE"
    return sentiment, prob

# Example predictions
print(predict_sentiment_saved("I watched worst movie, great acting!"))
print(predict_sentiment_saved("I loved the movie, great acting!."))